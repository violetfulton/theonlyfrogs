<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Only Frogs - Blog Poster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4caf50">
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: "Gaegu", sans-serif;
      background: #e8f5e9;
      margin: 0; padding: 20px;
    }
    h2 { color: #2e7d32; text-align: center; }
    form, #auth-section {
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px #aaa;
      max-width: 500px;
      margin: 10px auto;
    }
    input, textarea, button {
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      font-family: inherit;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: #4caf50;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #43a047; }
    .draft-btn {
      background: #039be5;
      margin-top: 5px;
    }
    .draft-btn:hover { background: #0288d1; }
    #status {
      text-align: center;
      font-weight: bold;
      margin-top: 10px;
    }
    #pending {
      max-width: 500px;
      margin: 10px auto;
      background: #f1f8e9;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    #pending h3 {
      margin: 5px 0;
      color: #33691e;
      font-size: 16px;
    }
    .pending-item {
      background: #fff;
      border: 1px solid #c5e1a5;
      padding: 8px;
      margin: 5px 0;
      border-radius: 5px;
      position: relative;
    }
    .delete-btn, .edit-btn, .publish-btn {
      position: absolute;
      top: 8px;
      border: none;
      color: white;
      border-radius: 5px;
      padding: 3px 8px;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn { right: 10px; background: #e53935; }
    .edit-btn { right: 70px; background: #039be5; }
    .publish-btn { right: 130px; background: #43a047; }
    .delete-btn:hover { background: #c62828; }
    .edit-btn:hover { background: #0288d1; }
    .publish-btn:hover { background: #2e7d32; }
    .content-editor {
      position: relative;
    }

    .image-upload-bar {
      background: #333;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .image-upload-btn {
      background: #4caf50;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    .uploading {
      color: #ffa500;
      font-size: 12px;
    }

    #content {
      min-height: 300px;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <h2>üê∏ Add a Blog Post</h2>

  <div id="auth-section">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Log In</button>
  </div>

  <form id="postForm" style="display:none;">
    <input type="text" id="title" placeholder="Title" required>
    <div class="content-editor">
      <div class="image-upload-bar">
        <input type="file" id="contentImage" accept="image/*" style="display: none;">
        <button type="button" class="image-upload-btn" onclick="selectImage()">üì∑ Add Image</button>
        <button type="button" class="image-upload-btn" onclick="selectMultipleImages()">üñºÔ∏è Add Gallery</button>
        <span id="uploadStatus" class="uploading"></span>
      </div>

      <label for="content">Content:</label>
      <textarea id="content" placeholder="Write your post content here... Images will be inserted at cursor position." rows="5" required></textarea>
    </div>
    <button type="submit">Post</button>
    <button type="button" id="saveDraftBtn" class="draft-btn">üíæ Save Draft</button>
  </form>

  <div id="pending" style="display:none;">
    <h3>üì¶ Pending & Draft Posts</h3>
    <div id="pendingList"></div>
  </div>

  <p id="status"></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getStorage } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js"; // Add this
    import { firebaseConfig } from "/_scripts/firebaseConfig.js";
    import { uploadBlogImage } from '/_scripts/uploadImage.js'; // Fix path

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app); // Add this

    const authSection = document.getElementById('auth-section');
    const postForm = document.getElementById('postForm');
    const statusEl = document.getElementById('status');
    const pendingDiv = document.getElementById('pending');
    const pendingList = document.getElementById('pendingList');
    const saveDraftBtn = document.getElementById('saveDraftBtn');

    let editIndex = null;
    let currentSlug = '';

    // Login
    document.getElementById('loginBtn').onclick = async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        statusEl.textContent = err.message;
      }
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        authSection.style.display = "none";
        postForm.style.display = "block";
        renderPending();
      }
    });

    // Post now
    postForm.onsubmit = async (e) => {
      e.preventDefault();
      const post = getFormData();

      if (editIndex !== null) {
        updateDraft(editIndex, post);
        return;
      }

      if (navigator.onLine) {
        try {
          await addDoc(collection(db, "posts"), { ...post, createdAt: serverTimestamp() });
          statusEl.textContent = "‚úÖ Posted successfully!";
          postForm.reset();
        } catch (err) {
          statusEl.textContent = "‚ùå " + err.message;
        }
      } else {
        queuePost(post);
      }
    };

    // Save Draft (always local)
    saveDraftBtn.onclick = () => {
      const post = getFormData();
      const drafts = JSON.parse(localStorage.getItem("offlinePosts") || "[]");
      drafts.push({ ...post, isDraft: true });
      localStorage.setItem("offlinePosts", JSON.stringify(drafts));
      postForm.reset();
      statusEl.textContent = "üíæ Draft saved locally (not auto-uploaded).";
      renderPending();
    };

    // Helpers
    function getFormData() {
      return {
        title: document.getElementById("title").value,
        content: document.getElementById("content").value,
        createdAt: new Date().toISOString()
      };
    }

    function queuePost(post) {
      const saved = JSON.parse(localStorage.getItem("offlinePosts") || "[]");
      saved.push(post);
      localStorage.setItem("offlinePosts", JSON.stringify(saved));
      statusEl.textContent = "üì¶ Saved offline! Will upload when online.";
      postForm.reset();
      renderPending();
    }

    function updateDraft(index, updated) {
      const saved = JSON.parse(localStorage.getItem("offlinePosts") || "[]");
      saved[index] = updated;
      localStorage.setItem("offlinePosts", JSON.stringify(saved));
      editIndex = null;
      postForm.reset();
      statusEl.textContent = "‚úèÔ∏è Draft updated.";
      renderPending();
    }

    function renderPending() {
      const saved = JSON.parse(localStorage.getItem("offlinePosts") || "[]");
      if (saved.length === 0) {
        pendingDiv.style.display = "none";
        return;
      }
      pendingDiv.style.display = "block";
      pendingList.innerHTML = "";
      saved.forEach((p, i) => {
        const type = p.isDraft ? "üíæ Draft" : "‚è≥ Queued";
        const item = document.createElement("div");
        item.className = "pending-item";
        item.innerHTML = `
          <strong>${p.title}</strong> <em>${type}</em><br>${p.content.substring(0, 60)}${p.content.length > 60 ? "..." : ""}
          ${p.isDraft ? `<button class="publish-btn" data-index="${i}">Publish</button>` : ""}
          <button class="edit-btn" data-index="${i}">Edit</button>
          <button class="delete-btn" data-index="${i}">Delete</button>
        `;
        pendingList.appendChild(item);
      });

      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", e => deletePending(parseInt(e.target.dataset.index)));
      });
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", e => editPending(parseInt(e.target.dataset.index)));
      });
      document.querySelectorAll(".publish-btn").forEach(btn => {
        btn.addEventListener("click", e => publishDraft(parseInt(e.target.dataset.index)));
      });
    }

    function deletePending(index) {
      const saved = JSON.parse(localStorage.getItem("offlinePosts") || "[]");
      const post = saved[index];
      if (confirm(`Delete "${post.title}"?`)) {
        saved.splice(index, 1);
        localStorage.setItem("offlinePosts", JSON.stringify(saved));
        renderPending();
        statusEl.textContent = "üóëÔ∏è Deleted.";
      }
    }

    function editPending(index) {
      const saved = JSON.parse(localStorage.getItem("offlinePosts") || "[]");
      const post = saved[index];
      document.getElementById("title").value = post.title;
      document.getElementById("content").value = post.content;
      editIndex = index;
      statusEl.textContent = `‚úèÔ∏è Editing "${post.title}".`;
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function publishDraft(index) {
      const saved = JSON.parse(localStorage.getItem("offlinePosts") || "[]");
      const post = saved[index];
      if (!navigator.onLine) {
        statusEl.textContent = "‚ö†Ô∏è You must be online to publish.";
        return;
      }
      try {
        await addDoc(collection(db, "posts"), { ...post, createdAt: serverTimestamp() });
        saved.splice(index, 1);
        localStorage.setItem("offlinePosts", JSON.stringify(saved));
        renderPending();
        statusEl.textContent = `‚úÖ Published "${post.title}" successfully!`;
      } catch (err) {
        statusEl.textContent = "‚ùå Error publishing: " + err.message;
      }
    }

    // Sync queued posts (not drafts)
    window.addEventListener("online", async () => {
      const saved = JSON.parse(localStorage.getItem("offlinePosts") || "[]");
      const toUpload = saved.filter(p => !p.isDraft);
      if (!toUpload.length) return;
      statusEl.textContent = `‚è´ Syncing ${toUpload.length} post(s)...`;
      for (const post of toUpload) {
        await addDoc(collection(db, "posts"), { ...post, createdAt: serverTimestamp() });
      }
      const remaining = saved.filter(p => p.isDraft);
      localStorage.setItem("offlinePosts", JSON.stringify(remaining));
      renderPending();
      statusEl.textContent = "‚úÖ All queued posts uploaded!";
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    window.addEventListener("load", renderPending);

    function generateSlug() {
      const title = document.getElementById('title').value;
      currentSlug = title.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .trim();
      return currentSlug;
    }

    window.selectImage = function() {
      document.getElementById('contentImage').click();
    };

    window.selectMultipleImages = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;
      input.onchange = handleMultipleImages;
      input.click();
    };

    document.getElementById('contentImage').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (file) {
        await insertImageIntoContent(file);
      }
    });

    async function handleMultipleImages(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      const statusEl = document.getElementById('uploadStatus');
      statusEl.textContent = `Uploading ${files.length} images...`;

      try {
        const slug = generateSlug() || 'draft-' + Date.now();
        const textarea = document.getElementById('content');
        const cursorPos = textarea.selectionStart;

        let galleryMarkup = '\n\n<div class="image-gallery">\n';

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          statusEl.textContent = `Uploading image ${i + 1} of ${files.length}...`;

          const imageUrl = await uploadBlogImage(file, slug);
          galleryMarkup += `  <img src="${imageUrl}" alt="${file.name}" class="gallery-image">\n`;
        }

        galleryMarkup += '</div>\n\n';

        // Insert gallery at cursor position
        const content = textarea.value;
        const newContent = content.slice(0, cursorPos) + galleryMarkup + content.slice(cursorPos);
        textarea.value = newContent;

        statusEl.textContent = `‚úÖ ${files.length} images uploaded!`;
        setTimeout(() => statusEl.textContent = '', 3000);

      } catch (error) {
        console.error('Error uploading images:', error);
        statusEl.textContent = '‚ùå Upload failed';
      }
    }

    async function insertImageIntoContent(file) {
      const statusEl = document.getElementById('uploadStatus');
      statusEl.textContent = 'Uploading image...';

      try {
        const slug = generateSlug() || 'draft-' + Date.now();
        const imageUrl = await uploadBlogImage(file, slug);

        // Insert image markdown at cursor position
        const textarea = document.getElementById('content');
        const cursorPos = textarea.selectionStart;
        const imageMarkdown = `\n\n![${file.name}](${imageUrl})\n\n`;

        const content = textarea.value;
        const newContent = content.slice(0, cursorPos) + imageMarkdown + content.slice(cursorPos);
        textarea.value = newContent;

        // Move cursor to end of inserted content
        const newCursorPos = cursorPos + imageMarkdown.length;
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.focus();

        statusEl.textContent = '‚úÖ Image uploaded!';
        setTimeout(() => statusEl.textContent = '', 3000);

      } catch (error) {
        console.error('Error uploading image:', error);
        statusEl.textContent = '‚ùå Upload failed';
      }
    }

    // Update title field to auto-generate slug
    document.getElementById('title').addEventListener('input', generateSlug);

    // Your existing submit function
    async function submitPost() {
      try {
        const title = document.getElementById('title').value;
        const content = document.getElementById('content').value;
        const slug = generateSlug();

        const postData = {
          title,
          content,
          slug,
          createdAt: new Date().toISOString(),
        };

        await addDoc(collection(db, "posts"), postData);
        console.log('‚úÖ Post created!');

        // Clear form
        document.getElementById('title').value = '';
        document.getElementById('content').value = '';

      } catch (error) {
        console.error('Error creating post:', error);
      }
    }

    // Make submitPost globally available
    window.submitPost = submitPost;
  </script>
</body>
</html>
