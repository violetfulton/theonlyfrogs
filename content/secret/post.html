<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>The Only Frogs - Blog Poster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#4caf50">
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: #1a1a1a;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    h2 { color: #2e7d32; text-align: center; }
    form, #auth-section {
      max-width: 600px;
      margin: 0 auto;
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #4caf50;
    }
    input, textarea, button {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #555;
      border-radius: 4px;
      background: #333;
      color: #fff;
      box-sizing: border-box;
    }
    button {
      background: #4caf50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #43a047; }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .draft-btn {
      background: #039be5;
    }
    .draft-btn:hover { background: #0288d1; }
    #status {
      text-align: center;
      margin: 20px 0;
      padding: 10px;
    }
    .content-editor {
      position: relative;
    }

    .image-upload-bar {
      background: #333;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .image-upload-btn {
      background: #4caf50;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      width: auto;
    }

    .uploading {
      color: #ffa500;
      font-size: 12px;
    }

    #content {
      min-height: 300px;
      font-family: monospace;
    }

    #content.drag-over {
      border: 2px dashed #4caf50;
      background-color: rgba(76, 175, 80, 0.1);
    }
  </style>
</head>
<body>
  <h2>üê∏ Add a Blog Post</h2>

  <div id="auth-section">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Log In</button>
    <p id="authStatus"></p>
  </div>

  <form id="postForm" style="display:none;">
    <input type="text" id="title" placeholder="Title" required>

    <div class="content-editor">
      <div class="image-upload-bar">
        <input type="file" id="contentImage" accept="image/*" style="display: none;">
        <button type="button" class="image-upload-btn" onclick="selectImage()">üì∑ Add Image</button>
        <button type="button" class="image-upload-btn" onclick="selectMultipleImages()">üñºÔ∏è Add Gallery</button>
        <span id="uploadStatus" class="uploading"></span>
      </div>

      <textarea id="content" placeholder="Write your post content here... Images will be inserted at cursor position."></textarea>
    </div>

    <button type="submit">Post</button>
    <button type="button" id="saveDraftBtn" class="draft-btn">üíæ Save Draft</button>
  </form>

  <p id="status"></p>

  <script type="module">
    if ('serviceWorker' in navigator) {
  // First, unregister any existing service worker
  navigator.serviceWorker.getRegistrations().then(function(registrations) {
    for(let registration of registrations) {
      registration.unregister().then(() => {
        console.log('Old service worker unregistered');
      });
    }
  }).then(() => {
    // Wait a moment, then register the new one
    setTimeout(() => {
      navigator.serviceWorker.register('/secret/sw.js', { scope: '/secret/' })
        .then(registration => {
          console.log('New service worker registered:', registration);
        })
        .catch(error => {
          console.log('Service worker registration failed:', error);
        });
    }, 1000);
  });
}

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
    import { firebaseConfig } from "/_scripts/firebaseConfig.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentSlug = '';

    // Image upload functions
    async function uploadBlogImage(file, postSlug) {
      try {
        const timestamp = Date.now();
        const filename = `${timestamp}-${file.name}`;
        const imagePath = `blog-images/${postSlug}/${filename}`;

        const imageRef = ref(storage, imagePath);
        const snapshot = await uploadBytes(imageRef, file);
        const downloadURL = await getDownloadURL(snapshot.ref);

        console.log('‚úÖ Image uploaded successfully:', downloadURL);
        return downloadURL;
      } catch (error) {
        console.error('‚ùå Error uploading image:', error);
        throw error;
      }
    }

    function generateSlug() {
      const title = document.getElementById('title').value;
      currentSlug = title.toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .trim();
      return currentSlug;
    }

    window.selectImage = function() {
      document.getElementById('contentImage').click();
    };

    window.selectMultipleImages = function() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.multiple = true;
      input.onchange = handleMultipleImages;
      input.click();
    };

    document.getElementById('contentImage').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (file) {
        await insertImageIntoContent(file);
      }
    });

    async function handleMultipleImages(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      const statusEl = document.getElementById('uploadStatus');
      statusEl.textContent = `Uploading ${files.length} images...`;

      try {
        const slug = generateSlug() || 'draft-' + Date.now();
        const textarea = document.getElementById('content');
        const cursorPos = textarea.selectionStart;

        let galleryMarkup = '\n\n<div class="image-gallery">\n';

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          statusEl.textContent = `Uploading image ${i + 1} of ${files.length}...`;

          const imageUrl = await uploadBlogImage(file, slug);
          galleryMarkup += `  <img src="${imageUrl}" alt="${file.name}" class="gallery-image">\n`;
        }

        galleryMarkup += '</div>\n\n';

        const content = textarea.value;
        const newContent = content.slice(0, cursorPos) + galleryMarkup + content.slice(cursorPos);
        textarea.value = newContent;

        statusEl.textContent = `‚úÖ ${files.length} images uploaded!`;
        setTimeout(() => statusEl.textContent = '', 3000);

      } catch (error) {
        console.error('Error uploading images:', error);
        statusEl.textContent = '‚ùå Upload failed';
      }
    }

    async function insertImageIntoContent(file) {
      const statusEl = document.getElementById('uploadStatus');
      statusEl.textContent = 'Uploading image...';

      try {
        const slug = generateSlug() || 'draft-' + Date.now();
        const imageUrl = await uploadBlogImage(file, slug);

        const textarea = document.getElementById('content');
        const cursorPos = textarea.selectionStart;
        const imageMarkdown = `\n\n![${file.name}](${imageUrl})\n\n`;

        const content = textarea.value;
        const newContent = content.slice(0, cursorPos) + imageMarkdown + content.slice(cursorPos);
        textarea.value = newContent;

        const newCursorPos = cursorPos + imageMarkdown.length;
        textarea.setSelectionRange(newCursorPos, newCursorPos);
        textarea.focus();

        statusEl.textContent = '‚úÖ Image uploaded!';
        setTimeout(() => statusEl.textContent = '', 3000);

      } catch (error) {
        console.error('Error uploading image:', error);
        statusEl.textContent = '‚ùå Upload failed';
      }
    }

    // Drag and drop handlers
    const contentTextarea = document.getElementById('content');

    contentTextarea.addEventListener('dragover', (e) => {
      e.preventDefault();
      contentTextarea.classList.add('drag-over');
    });

    contentTextarea.addEventListener('dragleave', (e) => {
      contentTextarea.classList.remove('drag-over');
    });

    contentTextarea.addEventListener('drop', async (e) => {
      e.preventDefault();
      contentTextarea.classList.remove('drag-over');

      const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));

      if (files.length === 1) {
        await insertImageIntoContent(files[0]);
      } else if (files.length > 1) {
        await handleMultipleImages({ target: { files } });
      }
    });

    // Update title field to auto-generate slug
    document.getElementById('title').addEventListener('input', generateSlug);

    // Authentication
    const loginBtn = document.getElementById('loginBtn');
    const authSection = document.getElementById('auth-section');
    const postForm = document.getElementById('postForm');
    const authStatus = document.getElementById('authStatus');

    loginBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (!email || !password) {
        authStatus.textContent = 'Please enter email and password';
        authStatus.style.color = 'red';
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Logging in...';
      authStatus.textContent = '';

      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (error) {
        console.error('Login error:', error);
        authStatus.textContent = 'Login failed: ' + error.message;
        authStatus.style.color = 'red';
        loginBtn.disabled = false;
        loginBtn.textContent = 'Log In';
      }
    });

    // Auth state listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        authSection.style.display = 'none';
        postForm.style.display = 'block';
        authStatus.textContent = '';
      } else {
        authSection.style.display = 'block';
        postForm.style.display = 'none';
        loginBtn.disabled = false;
        loginBtn.textContent = 'Log In';
      }
    });

    // Form submission
    document.getElementById('postForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = document.getElementById('title').value;
      const content = document.getElementById('content').value;
      const slug = generateSlug();

      if (!title || !content) {
        document.getElementById('status').textContent = 'Please fill in all fields';
        return;
      }

      try {
        const postData = {
          title,
          content,
          slug,
          createdAt: new Date().toISOString(),
          published: true
        };

        await addDoc(collection(db, "posts"), postData);

        document.getElementById('status').textContent = '‚úÖ Post published!';
        document.getElementById('status').style.color = 'green';

        // Clear form
        document.getElementById('title').value = '';
        document.getElementById('content').value = '';

      } catch (error) {
        console.error('Error creating post:', error);
        document.getElementById('status').textContent = '‚ùå Error: ' + error.message;
        document.getElementById('status').style.color = 'red';
      }
    });

  </script>
</body>
</html>
